# fedoc — стек и граф (30.10.2025)

Короткое резюме за день.

## Цели
- Исправить инверсию направлений рёбер при старте от узла (например, `c:dev-objects`).
- Обеспечить корректное отображение подсети fedoc, убрать «подъём» узла `c:backend` над `c:layer` при частичной подгрузке.
- Включить стандартное поведение: при старте от вершины отображать только нисходящий подграф (outbound) на заданную глубину.

## Сделано
1) Бэкенд (Flask + Apache AGE)
- Нормализация направлений рёбер: для каждого `edge_id` берём канонические `from/to` по Cypher (`id(a)`, `id(b)`), с fallback через `start_id/end_id`.
- Добавлен диагностический endpoint `/api/canonical_edge?id=...` для проверки канонического направления.
- Убрана серверная фильтрация/скрытие родителей в `/api/graph` — минимальный путь БД→API→Фронтенд.
- Для режима старта реализован запрос «только вниз» (outbound) на уровне Cypher:
  - `MATCH (s {arango_key:$start}) MATCH p=(s)-[*1..$depth]->(n)`
  - `UNWIND relationships(p) AS e` → уникализируем и возвращаем `id(e)`, `id(a)`, `id(b)` и свойства.
- Исправлены ошибки запроса (f-string, `reduce`/`UNWIND`, повторный `MATCH e`).

2) Фронтенд (Vue + Pinia + vis-network)
- Удалены эвристики по скрытию родителей при загрузке от старта.
- Исправлено: `hideNodeWithParents` больше не удаляет сам стартовый узел.
- Стабилизация раскладки без `network.setData(...)` (во избежание ошибки «Private element is not present...»); используем `stabilize()` + `fit()`.
- Очистка DataSet и сброс координат перед вставкой новых узлов/рёбер, чтобы не наследовать прошлые позиции.

## Проверки
- «Отобразить всё» и «start=c:dev-objects» — направления совпадают (инверсий нет).
- «start=c:backend&depth=5&project=fedoc» — загружается только outbound-подграф; `c:layer` (родитель) не попадает, порядок и направления соответствуют БД.

Примеры консольных проверок:

```javascript
// Каноника для конкретных рёбер
Promise.all([
  fetch('http://localhost:15000/api/canonical_edge?id=1125899906842625').then(r=>r.json()),
  fetch('http://localhost:15000/api/canonical_edge?id=1125899906842690').then(r=>r.json()),
  fetch('http://localhost:15000/api/canonical_edge?id=1125899906842689').then(r=>r.json()),
]).then(console.table)

// Сегмент от старта (только вниз)
fetch('http://localhost:15000/api/graph?start=c:backend&depth=5&project=fedoc')
  .then(r=>r.json())
  .then(j => {
    console.table((j.nodes||[]).map(n => ({ id:n.id, key:n._key, label:n.label })));
    console.table((j.edges||[]).map(e => ({ id:e.id, from:e.from, to:e.to, label:e.label })));
  })
```

## Итоговое поведение
- При старте от любой вершины возвращается только нисходящий подграф на глубину `depth` (outbound), без включения родителей.
- Направления рёбер — канонические и единообразные во всех режимах.
- Фронтенд отображает полученный сегмент без дополнительных трансформаций и без «залипания» прошлых позиций.

## Замечания / что дальше
- По запросу можно добавить уровни (`level`) в ответ БД для детерминированной иерархической раскладки (закрепить порядок типа `layer → backend → язык`).
- Готов продолжить анализ связанности подсети fedoc и фиксацию стека, когда потребуется.


