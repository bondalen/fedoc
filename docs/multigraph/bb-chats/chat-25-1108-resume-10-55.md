# Chat Resume — 2025-11-08 10:55

## Context

**Цель сессии:** Определение архитектуры развертывания и технологического стека для проекта fedoc multigraph

**Предыдущая сессия:** [chat-25-1107-resume-16-37.md](chat-25-1107-resume-16-37.md) — создана база данных, но архитектура приложения не определена

**Исходная проблема:**
- В предыдущем чате предлагалась "тяжелая" архитектура (FastAPI + несколько контейнеров)
- Не учитывался реальный сценарий: одиночный разработчик, ограниченные ресурсы
- Не решен вопрос сохранности данных при обновлении
- Не рассмотрена замена артефакта внутри работающего контейнера

---

## Выполнено

### 1. Уточнение требований ✅

**Сценарий использования:**
- Одиночный разработчик (не командная работа)
- Cursor AI (локально) ↔ MCP ↔ Backend API (удаленный сервер) ↔ PostgreSQL
- Веб-интерфейс для визуализации и прямого взаимодействия

**Ограничения:**
- Сервер с ограниченными ресурсами → минимизация контейнеров
- Обновление без потери данных БД
- Простота развертывания и обновления

### 2. Анализ архитектурных вариантов ✅

**Рассмотрено 6 вариантов:**

**Раунд 1 (до уточнений):**
- 1A: Монолитный контейнер + Docker Volumes
- 1B: Два контейнера (PostgreSQL + App) ⭐ — хороший вариант

**Раунд 2 (с заменой артефакта):**
- 3A: Java JAR + PostgreSQL в одном контейнере
- 3B-1: **Python Shiv (.pyz)** + PostgreSQL ⭐⭐⭐ — **ВЫБРАН**
- 3B-2: Python Wheel + pip install
- 3C: Hybrid (база в volume, app монтируется)

### 3. Принято архитектурное решение ✅

**Выбран вариант 3B-1:** Python Shiv (.pyz) в монолитном контейнере

**Архитектура:**
```
┌────────────────────────────────────────┐
│  Docker Container (ПОСТОЯННЫЙ)         │
│  ├─ PostgreSQL 16 + AGE (volume)       │
│  └─ Flask App (/app/app.pyz mounted)   │
│     Supervisor: postgres + python app  │
└────────────────────────────────────────┘
         ↑
    /opt/fedoc/app/app.pyz (хост)
```

**Обновление:**
```bash
wget new.pyz -O /opt/fedoc/app/app.pyz
docker exec container supervisorctl restart pythonapp
# PostgreSQL НЕ перезапускается → данные сохраняются!
```

**Ключевые преимущества:**
- ✅ Один контейнер (~800 MB RAM)
- ✅ Единый артефакт .pyz (30-40 MB)
- ✅ Быстрое обновление (2-5 сек)
- ✅ Данные сохраняются
- ✅ Знакомый стек (Python/Flask)

### 4. Определен технологический стек ✅

| Компонент | Технология | Обоснование |
|-----------|-----------|-------------|
| Backend | Flask 3.0+ | Простота, достаточно для одного пользователя |
| Frontend | Vue 3 + Vite | Текущий стек Graph Viewer |
| БД | PostgreSQL 16 + AGE | Готова, графовые запросы |
| Упаковка | Shiv (.pyz) | Единый артефакт, аналог JAR для Python |
| Развертывание | Docker монолит | Минимум ресурсов |
| MCP | Python (локально) | Cursor AI integration |

**Почему НЕ выбраны:**
- ❌ FastAPI — избыточная сложность
- ❌ Java — больше RAM, медленный старт, новый стек
- ❌ Два контейнера — дополнительные ресурсы (хотя архитектурно правильнее)

### 5. Спроектирована структура проекта ✅

```
fedoc/mgsrc/
├── backend/              # Flask + packaging
├── frontend/             # Vue 3
├── mcp_client/           # MCP (локально)
├── docker/               # Dockerfile, Supervisor
└── deploy/               # Скрипты развертывания
```

### 6. Реорганизована документация ✅

**Выполнено:**
- ✅ Создана `aa-main-docs/` — основная документация
- ✅ Создана `cc-preliminary/` — предварительные материалы
- ✅ Переименована `chats/` → `bb-chats/`
- ✅ Перемещена `25-1107/` → `cc-preliminary/25-1107/`
- ✅ Обновлены ссылки в существующих документах

**Новая структура:**
```
docs/multigraph/
├── aa-main-docs/
│   └── aa-project.md ← Основной проектный документ
├── bb-chats/
│   ├── chat-25-1107-resume-16-37.md
│   └── chat-25-1108-resume-10-55.md ← Этот файл
└── cc-preliminary/
    ├── 25-1107/ ← Создание БД
    └── 25-1108/ ← Определение архитектуры
        ├── chat-session-architecture-design.md
        └── psycopg2-shiv-test.md
```

### 7. Проведено подтверждающее тестирование ✅

- Развернут временный контейнер `apache/age` в сети `fedoc-postgres-age`
- Установлены `python3`, `pip`, `shiv`, `psycopg2-binary`
- Собран `.pyz`, выполняющий `SELECT 1` в рабочей БД
- Результат: `result: (1,)` — упаковка работает в целевой среде
- Детали: [psycopg2-shiv-test.md](../cc-preliminary/25-1108/psycopg2-shiv-test.md)

---

## Созданные артефакты

### Документация

1. **[aa-project.md](../aa-main-docs/aa-project.md)** — Основной проектный документ
   - Обзор проекта multigraph
   - Архитектура и стек
   - Модель данных
   - API спецификация
   - Roadmap

2. **[chat-session-architecture-design.md](../cc-preliminary/25-1108/chat-session-architecture-design.md)** — Детальное описание работы в чате
   - Полный анализ всех вариантов
   - Обоснование решений
   - Сравнительные таблицы
   - Примеры конфигураций

3. **[psycopg2-shiv-test.md](../cc-preliminary/25-1108/psycopg2-shiv-test.md)** — Подробный отчёт о тестировании `.pyz`
   - Описание окружения (контейнер `apache/age`)
   - Шаги установки зависимостей
   - Результаты запуска `SELECT 1`

4. **[chat-25-1108-resume-10-55.md](chat-25-1108-resume-10-55.md)** — Этот файл (резюме)

### База данных

**Статус:** ✅ Готова (создана в предыдущей сессии)
- Графы: `mg_blocks`, `mg_designs`
- Схема: `mg` (projects, design_to_block, design_edge_to_project)
- Детали: [multigraph-architecture-overview.md](../cc-preliminary/25-1107/multigraph-architecture-overview.md)

### Код

**Статус:** ❌ Не создан (следующий этап)

Структура запланирована, но файлы не созданы:
- `mgsrc/` директория не существует
- Backend, Frontend, MCP — в разработке
- Docker конфигурация — в разработке

---

## Next Steps

### Приоритет 1: Создание базовой структуры и MVP Backend

**Задачи:**
1. Создать структуру директорий `mgsrc/`
2. Инициализировать backend проект:
   - `fedoc_multigraph/` пакет
   - Flask app с базовым API
   - Подключение к PostgreSQL (psycopg2)
   - `setup.py` для packaging
3. Создать Docker конфигурацию:
   - `Dockerfile.base` (PostgreSQL + Python + Supervisor)
   - `supervisord.conf`
   - `init.sql` (инициализация схемы)
4. Разработать скрипт сборки:
   - `build-pyz.sh` для создания .pyz артефакта
5. Реализовать один working endpoint:
   - `POST /api/blocks` (создание блока)
6. Тестовая сборка .pyz и проверка

**Критерий завершения:**
- ✅ Можно собрать .pyz файл
- ✅ Можно запустить Flask app
- ✅ Можно создать блок через API
- ✅ Блок сохраняется в PostgreSQL/AGE

### Приоритет 2: MVP Frontend

**Задачи:**
1. Инициализировать Vue 3 + Vite проект
2. Создать базовый компонент визуализации (vis-network)
3. Интеграция с backend API
4. Настроить сборку в `backend/.../static/`

**Критерий завершения:**
- ✅ Frontend собирается и отдаётся Flask'ом
- ✅ Можно визуализировать пустой граф
- ✅ Можно вызвать API для создания блока

### Приоритет 3: MCP Client

**Задачи:**
1. Базовый MCP-сервер (локально)
2. Handler для создания блока
3. HTTP client для обращения к backend API
4. Тестирование в Cursor AI

**Критерий завершения:**
- ✅ MCP команда создаёт блок в БД
- ✅ Cursor AI может вызвать команду

### Приоритет 4: Развертывание

**Задачи:**
1. Скрипты `deploy/`:
   - `deploy.sh` — первоначальное развертывание
   - `update.sh` — обновление .pyz
   - `rollback.sh` — откат
2. Развертывание на fedoc-server
3. Smoke tests
4. Документация процесса

**Критерий завершения:**
- ✅ Контейнер работает на сервере
- ✅ Можно обновить приложение через update.sh
- ✅ Откат работает

---

## Open Questions

### Технические

1. **Shiv и C-extensions**
   - Статус: ✅ Проверено — `psycopg2-binary` работает в `.pyz` (см. [psycopg2-shiv-test.md](../cc-preliminary/25-1108/psycopg2-shiv-test.md))

2. **Supervisor restart delay**
   - Вопрос: Какой оптимальный `startsecs` для Flask app?
   - План: Начать с 5 сек, настроить по результатам

3. **Volume mount performance**
   - Вопрос: Будет ли bind mount /app/ быстрым на удаленном сервере?
   - План: Измерить при развертывании

### Архитектурные

4. **Миграция на два контейнера**
   - Вопрос: Когда стоит перейти на Вариант 1B (PostgreSQL отдельно)?
   - Критерий: Если RAM станет проблемой или потребуется масштабирование

5. **WebSocket scaling**
   - Вопрос: Как будет работать WebSocket при нескольких инстансах?
   - Ответ: Пока один пользователь → один инстанс, проблемы нет

---

## Lessons Learned

1. **Важность уточнения требований**
   - Первоначально предлагалась FastAPI + микросервисы
   - После уточнения сценария (один пользователь) — выбран Flask + монолит
   - **Урок:** Всегда начинать с use case, не с технологий

2. **Замена артефакта vs замена контейнера**
   - Вариант с заменой .pyz файла не был рассмотрен изначально
   - Только после уточнения пользователя — нашли оптимальное решение
   - **Урок:** Рассматривать все способы обновления

3. **Python Shiv как альтернатива JAR**
   - Shiv (PEP 441) позволяет создать единый .pyz артефакт
   - Менее известен, но отлично работает
   - **Урок:** Не только Java может иметь "executable jar"

4. **Trade-offs важнее best practices**
   - Монолитный контейнер "неправильно" архитектурно
   - Но для одного пользователя — оптимально
   - **Урок:** Best practices не абсолютны, зависят от контекста

---

## Связанные документы

### Предыдущие сессии
- [chat-25-1107-resume-16-37.md](chat-25-1107-resume-16-37.md) — Создание БД

### Основная документация
- [aa-project.md](../aa-main-docs/aa-project.md) — Основной проектный документ

### Детальные материалы
- [chat-session-architecture-design.md](../cc-preliminary/25-1108/chat-session-architecture-design.md) — Полный анализ архитектуры
- [psycopg2-shiv-test.md](../cc-preliminary/25-1108/psycopg2-shiv-test.md) — Отчёт о тестировании `.pyz`
- [multigraph-architecture-overview.md](../cc-preliminary/25-1107/multigraph-architecture-overview.md) — Детали БД

### Базовый проект fedoc
- [../../README.md](../../../README.md) — README основного проекта
- [../../project/decisions/](../../project/decisions/) — Архитектурные решения базового fedoc

---

## Hand-off для следующей сессии

**Готовность:** ✅ Готов к продолжению

**С чего начать:**
1. Прочитать [aa-project.md](../aa-main-docs/aa-project.md) — обзор проекта
2. При необходимости — [chat-session-architecture-design.md](../cc-preliminary/25-1108/chat-session-architecture-design.md) — детали решений
3. Создать структуру `mgsrc/` и начать разработку backend MVP

**Команда для старта:**
```bash
cd /home/alex/fedoc
mkdir -p mgsrc/{backend/fedoc_multigraph,frontend,mcp_client,docker,deploy}
cd mgsrc/backend
# Начать разработку согласно aa-project.md
```

**Фокус следующей сессии:** Backend MVP + Docker конфигурация

---

**Дата сессии:** 2025-11-08 (10:00 - 10:55)  
**Участники:** Александр, Claude (Cursor AI)  
**Статус:** ✅ Архитектура определена, подтверждена тестом, готово к разработке


